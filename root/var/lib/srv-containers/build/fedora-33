FROM docker.io/fedora:33

LABEL description="base fedora 33" maintainer="Pierre Dorgueil <pierre.dorgueil@gmail.com>"

# install addon software, enable system services, set passwords to 'fedora', app-adm is auto sudoer
RUN sed -i -e '/tsflags=nodocs/s/^/#/' /etc/dnf/dnf.conf; \
    yum install -y \
      NetworkManager \
      bind-utils \
      cockpit \
      hostname \
      iproute \
      iputils \
      less \
      man-db \
      man-pages \
      ncurses \
      net-tools \
      nmap \
      openssh-server \
      passwd \
      mlocate \
      sudo \
      systemd-udev \
      vim \
      wget \
      which \
      ;\
    yum reinstall -y bash; \
    yum clean all; \
    for s in cockpit.socket NetworkManager sshd; do systemctl enable $s; done; \
    for u in getty.target console-getty.service getty@tty1.service; do systemctl mask $u; done; \
    for p in /etc/pam.d/*; do grep -q 'pam_systemd\.so' $p && sed -i '/pam_systemd.so/s/^/# /' $p; done; \
    useradd -p '$6$tLnKt8PpAiNigDQ2$Hpv9wT982W0uTDkwTicF64bgBbwuaimfOen.lfhoxIDnN521nnNp8cKhujS2QkKw2Ja6mNafoTLMSexURo54/0' -s /bin/bash app-adm; \
    usermod -p '$6$tLnKt8PpAiNigDQ2$Hpv9wT982W0uTDkwTicF64bgBbwuaimfOen.lfhoxIDnN521nnNp8cKhujS2QkKw2Ja6mNafoTLMSexURo54/0' -s /bin/bash root; \
    echo "app-adm ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/app-adm

# allows for passwordless ssh access
COPY --chown=1000:1000 ./dot-ssh /home/app-adm/.ssh

CMD ["/sbin/init"]
