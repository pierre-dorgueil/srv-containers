#!/bin/bash

cd /var/lib/srv-containers/build

# dockerfiles to maintain
dockerfiles="alpine-3.12.0 centos-8.1.1911 centos-8.2.2004 fedora-33 fedora-34 suse-leap suse-tumbleweed debian-stable debian-unstable ubuntu-bionic ubuntu-focal kali-rolling"

mkpass() { python3 -c 'import crypt; print(crypt.crypt("'$1'", crypt.mksalt(crypt.METHOD_SHA512)))'; }

for f in $dockerfiles; do
    type=${f/-*/}; tag=${f/*-/}
    new=$(cat $type.tmpl end.tmpl | sed "s!@tag@!$tag!;s!@passhash@!$(mkpass $type)!")
    if [ ! -f $f ]; then
	changed=-1
    else
	cmp <(echo "$new"|sed "s/-p '$6.*'//") <(cat $f|sed "s/-p '$6.*'//") &>/dev/null
	changed=$?
	[ $changed -ne 0 ] && mv $f $f.bak
    fi
    if [ $changed -ne 0 ]; then
	echo "$new" > $f; ls -l $f 2>/dev/null
	[ $# -eq 0 ] && rm -f $f.bak
    fi
done
