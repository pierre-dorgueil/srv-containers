FROM docker.io/opensuse/tumbleweed

LABEL description="base OpenSUSE tumbleweed" maintainer="Pierre Dorgueil <pierre.dorgueil@gmail.com>"

# install addon software, enable system services, set passwords to 'suse', app-adm is auto sudoer
RUN sed -i 's/^\(rpm.install.excludedocs.*\)/# \1/' /etc/zypp/zypp.conf; \
    zypper install -y \
      NetworkManager \
      bash-doc \
      bind-utils \
      curl \
      less \
      man \
      man-pages \
      mlocate \
      ncat \
      net-tools \
      net-tools-deprecated \
      nmap \
      openssh \
      sudo \
      systemd-sysvinit \
      vim \
      wget \
      which \
      yast2 \
      ;\
    zypper install -y --force bash; \
    zypper clean; \
    for s in NetworkManager sshd; do systemctl enable $s; done; \
    for u in getty.target console-getty.service getty@tty1.service; do systemctl mask $u; done; \
    ln -s /usr/bin/ncat /usr/bin/nc; \
    for p in /etc/pam.d/*; do grep -q 'pam_systemd\.so' $p && sed -i '/pam_systemd.so/s/^/# /' $p; done; \
    useradd -p '$6$lg.3br3bcSh9eFIN$9m8zzKUlWMsbwJ.niPAf/24D7ug9CQse4HGZbdjEtpWTqU1VKxbZGa3nUU7V/.Rvi4mD3lJsYZ9598yMUSdfP/' -s /bin/bash app-adm; \
    usermod -p '$6$lg.3br3bcSh9eFIN$9m8zzKUlWMsbwJ.niPAf/24D7ug9CQse4HGZbdjEtpWTqU1VKxbZGa3nUU7V/.Rvi4mD3lJsYZ9598yMUSdfP/' -s /bin/bash root; \
    echo "app-adm ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/app-adm

# allows for passwordless ssh access
COPY --chown=1000:1000 ./dot-ssh /home/app-adm/.ssh

CMD ["/sbin/init"]
