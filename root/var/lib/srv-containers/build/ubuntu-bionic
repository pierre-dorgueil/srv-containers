FROM docker.io/ubuntu:bionic

LABEL description="base ubuntu bionic" maintainer="Pierre Dorgueil <pierre.dorgueil@gmail.com>"

ENV LANG=C

# install addon software, enable system services, set passwords to 'ubuntu'
RUN export DEBIAN_FRONTEND=noninteractive DEBCONF_NONINTERACTIVE_SEEN=true; \
    printf 'tzdata tzdata/Areas select Etc\ntzdata tzdata/Zones/Etc select MET\n' | debconf-set-selections; \
    sed -i '/^path-exclude=.usr.share.man/s/^/# /' /etc/dpkg/dpkg.cfg.d/excludes 2>/dev/null; \
    apt-get update -qqy; \
    apt-get install -qqy --no-install-recommends \
      apt-file \
      bash-completion \
      cockpit \
      cockpit-packagekit \
      cockpit-ws \
      curl \
      dnsutils \
      iproute2 \
      iputils-ping \
      less \
      locate \
      man-db \
      net-tools \
      network-manager \
      nmap \
      openssh-server \
      sudo \
      systemd-sysv \
      tzdata \
      vim \
      wget \
      ; \
    rm -f /etc/update-motd.d/60-unminimize; \
    dpkg -S /usr/share/man/ |sed 's|, |\n|g;s|: [^:]*$||' | xargs apt-get install --reinstall -y; \
    [ ! -x /usr/bin/ncat ] && apt-get install -qqy ncat; \
    ln -s /usr/bin/ncat /usr/bin/nc; \
    apt-get clean; \
    for s in cockpit ssh; do systemctl enable $s; done; \
    for u in getty.target console-getty.service getty@.service; do systemctl mask $u; done; \
    for p in /etc/pam.d/*; do grep -q 'pam_systemd\.so' $p && sed -i '/pam_systemd.so/s/^/# /' $p; done; \
    useradd -p '$6$qPl4LlsYNFP4zPXT$q7mhR7zQn4D4WA0ps8.m/TjTMwdOcASUbYEIQyxu0ybAA2fcB6eRHYM7ZamZE5iU6cQm521x.PU.5.gmU2eCk.' -s /bin/bash app-adm; \
    usermod -p '$6$qPl4LlsYNFP4zPXT$q7mhR7zQn4D4WA0ps8.m/TjTMwdOcASUbYEIQyxu0ybAA2fcB6eRHYM7ZamZE5iU6cQm521x.PU.5.gmU2eCk.' -s /bin/bash root; \
    echo "app-adm ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/app-adm

# allows for passwordless ssh access
COPY --chown=1000:1000 ./dot-ssh /home/app-adm/.ssh

CMD ["/sbin/init"]
